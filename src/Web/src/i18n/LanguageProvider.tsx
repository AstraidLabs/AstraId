import { createContext, useCallback, useContext, useEffect, useMemo, useState, type ReactNode } from "react";
import { DEFAULT_LOCALE, LOCALE_STORAGE_KEY, getPreferredLocale, normalizeLocale, setPreferredLocale, toLanguageTag, type SupportedLocale } from "./language";

type TranslationKey = string;

type TranslationSet = Record<TranslationKey, string>;

const en: TranslationSet = {
  "language.label": "Language",
  "language.popoverAria": "Select language",
  "language.listAria": "Supported languages",
  "language.searchPlaceholder": "Search language",
  "language.noResults": "No matching languages",
  "auth.backToHome": "Back to home",
  "auth.backToHomeAria": "Back to home",
  "auth.login.badge": "Authorization Portal",
  "auth.register.badge": "Account Registration",
  "login.metaTitle": "AstraId | Sign in",
  "login.metaDescription": "Sign in to AstraId to securely access your account and enterprise identity features.",
  "login.cardTitle": "Sign in",
  "login.cardDescription": "Access your AstraId account securely.",
  "login.emailOrUsername": "Email or username",
  "login.password": "Password",
  "login.forgotPassword": "Forgot password?",
  "login.hidePassword": "Hide password",
  "login.showPassword": "Show password",
  "login.submit": "Sign in",
  "login.submitting": "Signing in...",
  "login.createAccount": "Create account",
  "register.metaTitle": "AstraId | Create account",
  "register.metaDescription": "Create a new AstraId account with secure registration and enterprise-grade protection.",
  "register.cardTitle": "Create account",
  "register.cardDescription": "Set up your AstraId account.",
  "register.email": "Email",
  "register.password": "Password",
  "register.confirmPassword": "Confirm password",
  "register.passwordHint": "Use at least 8 characters with a mix of letters and numbers.",
  "register.hidePassword": "Hide password",
  "register.showPassword": "Show password",
  "register.hideConfirmedPassword": "Hide confirmed password",
  "register.showConfirmedPassword": "Show confirmed password",
  "register.submit": "Create account",
  "register.submitting": "Creating account...",
  "register.signIn": "Already have an account? Sign in",
  "common.home": "Home",
  "common.login": "Login",
  "common.register": "Register",
  "common.account": "Account",
  "common.admin": "Admin",
  "common.logout": "Logout",
  "common.loadingSession": "Checking session…",
  "common.validationFailed": "Validation failed.",
  "common.requestFailed": "Request failed.",
  "auth.layoutTitle": "AstraId authentication",
  "auth.layoutSection": "Authentication form",
  "auth.metaTitle": "AstraId | Authentication",
  "auth.metaDescription": "Sign in or register for AstraId with secure authentication and account protections.",
  "forgot.title": "Reset password",
  "forgot.description": "Enter the email to reset your password.",
  "forgot.email": "Email",
  "forgot.submit": "Send reset link",
  "forgot.submitting": "Sending...",
  "forgot.success": "If an account exists for this email, you’ll receive a password reset link shortly.",
  "reset.title": "Set a new password",
  "reset.email": "Email",
  "reset.token": "Verification token",
  "reset.newPassword": "New password",
  "reset.confirmPassword": "Confirm new password",
  "reset.submit": "Update password",
  "reset.submitting": "Saving...",
  "reset.success": "Your password was updated. Please sign in again.",
  "activate.title": "Activate account",
  "activate.email": "Email",
  "activate.token": "Verification token",
  "activate.submit": "Activate account",
  "activate.submitting": "Activating...",
  "activate.success": "Your account has been activated. Please sign in.",
  "mfa.title": "Two-factor authentication",
  "mfa.description": "Enter the code from your authenticator app or use a recovery code.",
  "mfa.code": "Verification code",
  "mfa.recoveryCode": "Recovery code",
  "mfa.useRecovery": "Use a recovery code",
  "mfa.remember": "Trust this device",
  "mfa.submit": "Continue",
  "mfa.submitting": "Verifying...",
  "mfa.tokenMissing": "The MFA challenge is no longer available. Please sign in again.",
  "signedIn.goSecurity": "Go to account security",
  "account.sidebarTitle": "Account",
  "account.nav.overview": "Profile",
  "account.nav.security": "Security",
  "account.nav.privacy": "Privacy",
  "account.overview.title": "Profile",
  "account.overview.description": "Your self-service account dashboard.",
  "account.security.title": "Security",
  "account.security.description": "Manage account protections with dedicated security controls.",
  "account.sessions.title": "Sign out all sessions",
  "account.sessions.description": "Invalidate all active sessions except the current flow.",
  "account.sessions.confirm": "Sign out all active sessions? You will need to sign in again on other devices.",
  "account.sessions.submit": "Sign out all sessions",
  "account.sessions.submitting": "Signing out...",
  "account.events.title": "Recent login activity",
  "account.events.description": "Review recent sign-ins and token issuances for your account.",
  "account.events.empty": "No recent login history.",
  "account.events.time": "Time (UTC)",
  "account.events.result": "Result",
  "account.events.client": "Client",
  "account.events.ip": "IP",
  "account.events.userAgent": "User agent",
  "account.events.success": "Success",
  "account.events.failed": "Failed",
  "account.dropdown.aria": "Account menu",
  "error.403.description": "You don’t have permission to access this page.",
  "error.403.hint": "If you believe this is a mistake, contact an administrator.",
  "error.404.description": "The requested resource was not found.",
  "error.404.hint": "Check the URL or use the navigation to find what you need.",
  "error.500.description": "Something went wrong on our side. Please try again.",
  "error.500.hint": "If the issue persists, contact support and share the trace ID.",
  "footer.copyright": "© {{year}} AstraId",
  "common.metaTitle": "AstraId | Secure Identity",
  "common.metaDescription": "AstraId secure identity portal for sign-in, account management, and access control.",
  "common.main": "Main content",
  "common.primaryNavigation": "Primary",
  "common.unknown": "Unknown",
  "common.unknownUser": "Unknown user",
  "common.notAvailable": "N/A",
  "common.yes": "Yes",
  "common.no": "No",
  "common.submitting": "Submitting...",
  "home.title": "Public UI",
  "home.description": "Public sign-in interface for users.",
  "home.loading": "Loading session...",
  "home.authenticated": "You are signed in. Nothing else to show here yet.",
  "home.user": "User",
  "home.id": "ID",
  "home.email": "Email",
  "home.roles": "Roles",
  "home.permissions": "Permissions",
  "home.anonymous": "You are not signed in. Continue by signing in or registering.",
  "profile.title": "User profile",
  "profile.description": "Information from the identity token and /api/me.",
  "profile.notSignedIn": "You are not signed in. Sign in to view your profile.",
  "profile.permissions": "Permissions",
  "profile.permissionsEmpty": "No permissions found in the token or /api/me.",
  "profile.loading": "Loading data from the API...",
  "profile.error": "Unable to load profile.",
  "integrations.title": "Integrations",
  "integrations.description": "Check the availability of connected services.",
  "integrations.signInRequired": "Sign in to check integrations.",
  "integrations.adminPermissionRequired": "Integrations require the system.admin permission.",
  "integrations.unavailable": "Integrations are unavailable.",
  "integrations.missingToken": "Missing access token.",
  "integrations.authServerPing": "AuthServer ping",
  "integrations.cmsPing": "CMS ping",
  "admin.page.title": "Administration",
  "admin.page.description": "Administration is available only in AuthServer.",
  "admin.page.location": "Admin UI is available at:",
  "admin.page.hint": "If you are an administrator, open it in a new tab.",
  "admin.page.open": "Open administration",
  "callback.title": "Signing you in",
  "callback.description": "Processing the OIDC callback.",
  "callback.progress": "Completing sign-in...",
  "callback.error": "We couldn’t complete the sign-in.",
  "confirmEmail.title": "Confirm email change",
  "confirmEmail.description": "Click the button below to confirm your new email address.",
  "confirmEmail.submit": "Confirm email change",
  "confirmEmail.submitting": "Confirming...",
  "confirmEmail.backToLogin": "Back to login",
  "confirmEmail.success": "Your email has been updated.",
  "confirmEmail.error": "Unable to confirm email change.",
  "activate.alreadySignedIn": "You are already signed in. Account activation links are intended for email verification flows.",
  "activate.backToSignIn": "Back to sign in",
  "account.profile.title": "Profile",
  "account.profile.description": "Review basic account information from your current session.",
  "account.profile.username": "Username",
  "account.profile.email": "Email",
  "account.profile.userId": "User ID",
  "account.profile.authentication": "Authentication",
  "account.profile.active": "Active",
  "account.profile.inactive": "Inactive",
  "account.overview.email": "Email",
  "account.overview.emailStatus": "Email status",
  "account.overview.verified": "Verified",
  "account.overview.verificationRequired": "Verification required",
  "account.overview.mfa": "MFA",
  "account.overview.enabled": "Enabled",
  "account.overview.disabled": "Disabled",
  "account.overview.profileCard": "Review your account identity details.",
  "account.overview.securityCard": "Open enterprise security controls and activity pages.",
  "account.email.title": "Email",
  "account.email.description": "Request a change for your account email address.",
  "account.email.newEmail": "New email",
  "account.email.currentPassword": "Current password",
  "account.email.submit": "Send confirmation link",
  "account.email.success": "Check your email for a confirmation link.",
  "account.email.error": "Unable to request email change.",
  "account.password.title": "Password",
  "account.password.description": "Change your password and optionally sign out other sessions.",
  "account.password.current": "Current password",
  "account.password.new": "New password",
  "account.password.confirm": "Confirm password",
  "account.password.signOutOthers": "Sign out other sessions",
  "account.password.submit": "Update password",
  "account.password.updating": "Updating...",
  "account.password.success": "Password updated.",
  "account.password.error": "Unable to update password.",
  "account.sessions.success": "Other sessions were signed out.",
  "account.sessions.error": "Unable to revoke sessions.",
  "account.mfa.title": "MFA",
  "account.mfa.description": "Manage multi-factor authentication for your account.",
  "account.mfa.loading": "Loading MFA status...",
  "account.mfa.loadError": "Unable to load MFA status.",
  "account.mfa.actionError": "Unable to complete MFA action.",
  "account.mfa.status": "MFA status",
  "account.mfa.recoveryCodesLeft": "Recovery codes left",
  "account.mfa.start": "Start MFA setup",
  "account.mfa.sharedKey": "Shared key",
  "account.mfa.verifyEnable": "Verify & enable MFA",
  "account.mfa.enabled": "MFA enabled.",
  "account.mfa.authenticatorCode": "Authenticator code",
  "account.mfa.disable": "Disable MFA",
  "account.mfa.disabledMsg": "MFA disabled.",
  "account.mfa.generateCodes": "Generate recovery codes",
  "account.mfa.codesGenerated": "Recovery codes generated.",
  "account.mfa.startError": "Unable to start MFA setup.",
  "account.mfa.enterVerification": "Enter the verification code from your authenticator app.",
  "account.mfa.verifyError": "Unable to verify the code.",
  "account.mfa.regenError": "Unable to regenerate recovery codes.",
  "account.mfa.enterCode": "Enter the verification code.",
  "account.mfa.disableError": "Unable to disable MFA.",
  "account.mfa.qrAria": "QR code for MFA",
  "account.mfa.loadingQr": "Loading QR…",
  "account.mfa.scanQr": "Scan the QR code or use the key:",
  "account.mfa.recoveryCodes": "Recovery codes",
  "account.security.signInRequired": "You must be signed in to manage security settings.",
  "account.security.loading": "Loading security settings...",
  "account.security.loadError": "Unable to load security data.",
  "account.security.emailVerified": "Email verified",
  "account.security.legacyDescription": "Use the dedicated security center to manage password, email, sessions, and MFA.",
  "account.security.openCenter": "Open security center",
  "account.privacy.title": "Privacy",
  "account.privacy.description": "Export your data and manage deletion requests.",
  "account.privacy.exportTitle": "Export my data",
  "account.privacy.exportHelp": "Download a machine-readable JSON export of your account data.",
  "account.privacy.exportButton": "Export my data",
  "account.privacy.exportFailed": "Failed to export your data.",
  "account.privacy.exportDownloaded": "Data export downloaded.",
  "account.privacy.deleteTitle": "Account deletion",
  "account.privacy.deleteHelp": "Request deletion of your account after a cooldown period.",
  "account.privacy.requestDelete": "Request deletion",
  "account.privacy.cancelDelete": "Cancel deletion",
  "account.privacy.deletionRequested": "Deletion requested. Cooldown until {{time}}.",
  "account.privacy.deletionCancelled": "Deletion request cancelled.",
  "diagnostics.title": "Diagnostics",
  "diagnostics.errorId": "Error ID",
  "diagnostics.traceId": "Trace ID",
  "diagnostics.exception": "Exception",
  "diagnostics.request": "Request",
  "diagnostics.innerException": "Inner exception",
  "security.mfa": "MFA management",
  "security.email": "Change email",
  "security.password": "Change password",
  "security.sessions": "Sign out all sessions",
  "security.activity": "Recent login activity",
  "security.mfa.description": "Set up, disable, and recover multi-factor authentication.",
  "security.email.description": "Start a secured email change flow and confirm ownership.",
  "security.password.description": "Update your password and refresh account protection.",
  "security.sessions.description": "Invalidate sessions on every other device.",
  "security.activity.description": "Review recent sign-in successes, failures, and logout events.",
  "privacy.export": "Export my data",
  "privacy.delete": "Request deletion",
};

const translations: Record<SupportedLocale, TranslationSet> = {
  en,
  cs: {
    ...en,
    "language.label": "Jazyk",
    "language.popoverAria": "Vyberte jazyk",
    "language.listAria": "Podporované jazyky",
    "language.searchPlaceholder": "Hledat jazyk",
    "language.noResults": "Žádné odpovídající jazyky",
    "auth.backToHome": "Zpět na hlavní stránku",
    "auth.backToHomeAria": "Zpět na hlavní stránku",
    "auth.login.badge": "Autorizační portál",
    "auth.register.badge": "Registrace účtu",
    "login.metaTitle": "AstraId | Přihlášení",
    "login.metaDescription": "Přihlaste se do AstraId a získejte bezpečný přístup ke svému účtu a podnikovým funkcím identity.",
    "login.cardTitle": "Přihlášení",
    "login.cardDescription": "Bezpečný přístup k vašemu účtu AstraId.",
    "login.emailOrUsername": "E-mail nebo uživatelské jméno",
    "login.password": "Heslo",
    "login.forgotPassword": "Zapomenuté heslo?",
    "login.hidePassword": "Skrýt heslo",
    "login.showPassword": "Zobrazit heslo",
    "login.submit": "Přihlásit se",
    "login.submitting": "Přihlašování...",
    "login.createAccount": "Vytvořit účet",
    "register.metaTitle": "AstraId | Vytvoření účtu",
    "register.metaDescription": "Vytvořte si nový účet AstraId se zabezpečenou registrací a ochranou na podnikové úrovni.",
    "register.cardTitle": "Vytvořit účet",
    "register.cardDescription": "Nastavte svůj účet AstraId.",
    "register.email": "E-mail",
    "register.password": "Heslo",
    "register.confirmPassword": "Potvrzení hesla",
    "register.passwordHint": "Použijte alespoň 8 znaků v kombinaci písmen a číslic.",
    "register.hidePassword": "Skrýt heslo",
    "register.showPassword": "Zobrazit heslo",
    "register.hideConfirmedPassword": "Skrýt potvrzené heslo",
    "register.showConfirmedPassword": "Zobrazit potvrzené heslo",
    "register.submit": "Vytvořit účet",
    "register.submitting": "Vytváření účtu...",
    "register.signIn": "Už máte účet? Přihlaste se"
  },
  de: {
    ...en,
    "language.label": "Sprache",
    "language.popoverAria": "Sprache auswählen",
    "language.listAria": "Unterstützte Sprachen",
    "language.searchPlaceholder": "Sprache suchen",
    "language.noResults": "Keine passenden Sprachen",
    "auth.backToHome": "Zur Startseite",
    "auth.backToHomeAria": "Zur Startseite",
    "auth.login.badge": "Autorisierungsportal",
    "auth.register.badge": "Konto registrieren",
    "login.metaTitle": "AstraId | Anmelden",
    "login.metaDescription": "Melden Sie sich bei AstraId an, um sicher auf Ihr Konto und auf unternehmensweite Identitätsfunktionen zuzugreifen.",
    "login.cardTitle": "Anmelden",
    "login.cardDescription": "Sicherer Zugriff auf Ihr AstraId-Konto.",
    "login.emailOrUsername": "E-Mail oder Benutzername",
    "login.password": "Passwort",
    "login.forgotPassword": "Passwort vergessen?",
    "login.hidePassword": "Passwort ausblenden",
    "login.showPassword": "Passwort anzeigen",
    "login.submit": "Anmelden",
    "login.submitting": "Anmeldung läuft...",
    "login.createAccount": "Konto erstellen",
    "register.metaTitle": "AstraId | Konto erstellen",
    "register.metaDescription": "Erstellen Sie ein neues AstraId-Konto mit sicherer Registrierung und Schutz auf Unternehmensniveau.",
    "register.cardTitle": "Konto erstellen",
    "register.cardDescription": "Richten Sie Ihr AstraId-Konto ein.",
    "register.email": "E-Mail",
    "register.password": "Passwort",
    "register.confirmPassword": "Passwort bestätigen",
    "register.passwordHint": "Verwenden Sie mindestens 8 Zeichen mit einer Kombination aus Buchstaben und Zahlen.",
    "register.hidePassword": "Passwort ausblenden",
    "register.showPassword": "Passwort anzeigen",
    "register.hideConfirmedPassword": "Bestätigtes Passwort ausblenden",
    "register.showConfirmedPassword": "Bestätigtes Passwort anzeigen",
    "register.submit": "Konto erstellen",
    "register.submitting": "Konto wird erstellt...",
    "register.signIn": "Sie haben bereits ein Konto? Anmelden"
  },
  pl: {
    ...en,
    "language.label": "Język",
    "language.popoverAria": "Wybierz język",
    "language.listAria": "Obsługiwane języki",
    "language.searchPlaceholder": "Szukaj języka",
    "language.noResults": "Brak pasujących języków",
    "auth.backToHome": "Powrót do strony głównej",
    "auth.backToHomeAria": "Powrót do strony głównej",
    "auth.login.badge": "Portal autoryzacji",
    "auth.register.badge": "Rejestracja konta",
    "login.metaTitle": "AstraId | Zaloguj się",
    "login.metaDescription": "Zaloguj się do AstraId, aby bezpiecznie uzyskać dostęp do konta i firmowych funkcji tożsamości.",
    "login.cardTitle": "Zaloguj się",
    "login.cardDescription": "Bezpieczny dostęp do konta AstraId.",
    "login.emailOrUsername": "E-mail lub nazwa użytkownika",
    "login.password": "Hasło",
    "login.forgotPassword": "Nie pamiętasz hasła?",
    "login.hidePassword": "Ukryj hasło",
    "login.showPassword": "Pokaż hasło",
    "login.submit": "Zaloguj się",
    "login.submitting": "Logowanie...",
    "login.createAccount": "Utwórz konto",
    "register.metaTitle": "AstraId | Utwórz konto",
    "register.metaDescription": "Utwórz nowe konto AstraId z bezpieczną rejestracją i ochroną klasy korporacyjnej.",
    "register.cardTitle": "Utwórz konto",
    "register.cardDescription": "Skonfiguruj swoje konto AstraId.",
    "register.email": "E-mail",
    "register.password": "Hasło",
    "register.confirmPassword": "Potwierdź hasło",
    "register.passwordHint": "Użyj co najmniej 8 znaków, łącząc litery i cyfry.",
    "register.hidePassword": "Ukryj hasło",
    "register.showPassword": "Pokaż hasło",
    "register.hideConfirmedPassword": "Ukryj potwierdzone hasło",
    "register.showConfirmedPassword": "Pokaż potwierdzone hasło",
    "register.submit": "Utwórz konto",
    "register.submitting": "Tworzenie konta...",
    "register.signIn": "Masz już konto? Zaloguj się"
  },
  sk: {
    ...en,
    "language.label": "Jazyk",
    "language.popoverAria": "Vyberte jazyk",
    "language.listAria": "Podporované jazyky",
    "language.searchPlaceholder": "Vyhľadať jazyk",
    "language.noResults": "Žiadne zodpovedajúce jazyky",
    "auth.backToHome": "Späť na hlavnú stránku",
    "auth.backToHomeAria": "Späť na hlavnú stránku",
    "auth.login.badge": "Autorizačný portál",
    "auth.register.badge": "Registrácia účtu",
    "login.metaTitle": "AstraId | Prihlásenie",
    "login.metaDescription": "Prihláste sa do AstraId a získajte bezpečný prístup k svojmu účtu a podnikovým funkciám identity.",
    "login.cardTitle": "Prihlásenie",
    "login.cardDescription": "Bezpečný prístup k vášmu účtu AstraId.",
    "login.emailOrUsername": "E-mail alebo používateľské meno",
    "login.password": "Heslo",
    "login.forgotPassword": "Zabudnuté heslo?",
    "login.hidePassword": "Skryť heslo",
    "login.showPassword": "Zobraziť heslo",
    "login.submit": "Prihlásiť sa",
    "login.submitting": "Prihlasovanie...",
    "login.createAccount": "Vytvoriť účet",
    "register.metaTitle": "AstraId | Vytvorenie účtu",
    "register.metaDescription": "Vytvorte si nový účet AstraId so zabezpečenou registráciou a ochranou na podnikovej úrovni.",
    "register.cardTitle": "Vytvoriť účet",
    "register.cardDescription": "Nastavte si účet AstraId.",
    "register.email": "E-mail",
    "register.password": "Heslo",
    "register.confirmPassword": "Potvrdenie hesla",
    "register.passwordHint": "Použite aspoň 8 znakov v kombinácii písmen a číslic.",
    "register.hidePassword": "Skryť heslo",
    "register.showPassword": "Zobraziť heslo",
    "register.hideConfirmedPassword": "Skryť potvrdené heslo",
    "register.showConfirmedPassword": "Zobraziť potvrdené heslo",
    "register.submit": "Vytvoriť účet",
    "register.submitting": "Vytváranie účtu...",
    "register.signIn": "Už máte účet? Prihláste sa"
  }
};

type LanguageContextValue = {
  locale: SupportedLocale;
  setLocale: (locale: string) => void;
  t: (key: TranslationKey) => string;
};

const LanguageContext = createContext<LanguageContextValue | null>(null);

export const LanguageProvider = ({ children }: { children: ReactNode }) => {
  const [locale, setLocaleState] = useState<SupportedLocale>(() => getPreferredLocale());

  const setLocale = useCallback((nextLocale: string) => {
    const normalized = setPreferredLocale(nextLocale);
    setLocaleState(normalized);
  }, []);

  useEffect(() => {
    document.documentElement.lang = toLanguageTag(locale);
  }, [locale]);

  useEffect(() => {
    const onStorage = (event: StorageEvent) => {
      if (event.key !== null && event.key !== LOCALE_STORAGE_KEY && event.key !== "astraid.lang") {
        return;
      }
      setLocaleState(normalizeLocale(event.newValue));
    };

    window.addEventListener("storage", onStorage);
    return () => window.removeEventListener("storage", onStorage);
  }, []);

  const value = useMemo<LanguageContextValue>(() => ({
    locale,
    setLocale,
    t: (key) => translations[locale][key] ?? translations[DEFAULT_LOCALE][key]
  }), [locale, setLocale]);

  return <LanguageContext.Provider value={value}>{children}</LanguageContext.Provider>;
};

export const useLanguage = () => {
  const context = useContext(LanguageContext);
  if (!context) {
    throw new Error("useLanguage must be used within LanguageProvider");
  }
  return context;
};
